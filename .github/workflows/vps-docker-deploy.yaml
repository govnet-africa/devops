name: Deploy to docker host
  
on: 
  workflow_dispatch:
  workflow_call:
    inputs:
      service:
        required: true
        type: string
      tag:
        required: false
        type: string
        default: ${{ github.sha }}
      deploy-host:
        required: false
        type: string
        default: "${{ inputs.service }}.ifas.mofa"
      deploy-host-ip:
        required: false
        type: string
        default: '109.74.200.222'
      deploy-user:
        required: false
        type: string
        default: 'github-actions'
      deploy-dir:
        required: false
        type: string
        default: '/deploy/mofa-ifas'
jobs:
  docker_deploy:
    runs-on: ubuntu-latest
    permissions: 
      id-token: write
      contents: read
    steps:
      - name: Configure Host SSH
        uses: shimataro/ssh-key-action@v2
        with:
          name: ifas_github
          known_hosts: |
            109.74.200.222 ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCqdb1Ttf3aoyxwpSCkVdvu8HKv+fjLNLYut2hfft5cEy7O6HOkUfdp+mLjuwuv7ipi89iBo3DQUGQoyWdqZ0YTbPvm9N6ZvhhydkEhTK6461Yz1SHO2CaZIbCDGQbtW6/bI3o3Q3/RnJ5zNPxQYznsqLAZHRqir/9E3PWIin+hg5zTRSMe1JxU2mrkMbe2LXu7ghIv7jmWZ1ZTN6qsNZBGjYi2SCvmkkA3ZJTI3rID1gfdHW/OToymc/bcMgQREvnZSqmZx/GmVUWrMjfeoAByeA6qM58cFuFKzv1EsBKz/V64pRIpqSpVjzE1Dr5//CEkJXeNME2ReJsWoWHc617lv9BZbO50k2LCFRdLF8n3ikRz3cqMNhfPOPBn4Ukgn7WquhhkX1lC7yfCzmCpbA/2TZbtB17yNw3VDzjU9YIMhqfOF6hhBkv8EUIYk1CZvp5ogMEpFIrUy+1VIxvQDyxdezZbg0ofLybx4yszpJiQBTMBhhHDsuRSUgaXg5XEN38=
            109.74.200.222 ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBKI2X8Yg3tJrHQ/IU69ctRkaK7vYDM3qW8hSIdF1kpJW0txXn/lH6Q+6gA4k2PyfU9+300oBDUK7N3P2stXu/j4=
            109.74.200.222 ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIC+FWVwbl6RR3d5hMjw7GOKgtraLqWeh9dWnXYhIJyuI
          config: |
            Host ${{ inputs.deploy-host }}
              HostName ${{ inputs.deploy-host-ip }}
              User ${{ inputs.deploy-user }}
              IdentityFile ~/.ssh/ifas_github
          key: |
            -----BEGIN OPENSSH PRIVATE KEY-----
            b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW
            QyNTUxOQAAACCxhDsc4Jetw6+ZRU3e8kTBAOUcDJD0C0wgLkFrQ+m3sAAAAJgVMHDkFTBw
            5AAAAAtzc2gtZWQyNTUxOQAAACCxhDsc4Jetw6+ZRU3e8kTBAOUcDJD0C0wgLkFrQ+m3sA
            AAAEC1X81ZVM+fkLipdlmaz5JO7PX8NEqDt+xFQLPG11aH3LGEOxzgl63Dr5lFTd7yRMEA
            5RwMkPQLTCAuQWtD6bewAAAAFWdpdGh1YkBtb2ZhLmdvdm5ldC51Zw==
            -----END OPENSSH PRIVATE KEY-----
      - name: Deploy ${{ inputs.service }} with docker
        run: ssh ${{ inputs.deploy-host }} "make -C  ${{ inputs.deploy-dir }} deploy-service-tag service=${{ inputs.service }} tag=${{ inputs.tag }}"